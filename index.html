<!-- start server by typing python3 -m http.server 8000 -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Michigan Counties Map</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'>
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css' rel='stylesheet'>

  <style>
    body { margin: 0; padding: 0; }
    .info-info {
      padding: 8px;
      background-color: white; 
      display: block;
      position: absolute; 
      top: 40px; 
      left: 10px; 
      padding: 10px; 
      border-radius: 3px;
      z-index: 1;
    } 
    .search-input {
      display: block;
      width: 155px;
      position: absolute;
      top: 10px;
      left: 10px;
      align-items: center;
    }
  </style>
</head>
<body>

<div class="info-info" id='info'>Search an address for results</div>
<div class="search-input" id="searchInput">
    <input type="text" id="searchField" style="position: absolute; top:10px; left: 5px;" placeholder="Search by City, ZIP, Address...">
</div>
<button id="searchButton" style="position: absolute; top:10px; left: 180px;">Search</button>

<script>

const twpTile = 'sgoergen.cwfj8c5h'
const schoolTile = 'sgoergen.4ev89ja0'
const countyTile = 'sgoergen.7bkrwr5z'
const accessToken = 'sk.eyJ1Ijoic2dvZXJnZW4iLCJhIjoiY2xyYjdwMnZlMGx5ejJqcW40Z2Y0ajBoaSJ9.LGsPdV8lGAyqriVkD0EEaA';

const searchInput = document.getElementById('searchField');
const searchButton = document.getElementById('searchButton');

const geocoder = new MapboxGeocoder({
    placeholder: 'Search by City, ZIP, Address...',
    accessToken: accessToken,
});

// Declare infoDiv before using it
const infoDiv = document.getElementById('info');

searchButton.addEventListener('click', function() {
    const searchAddress = searchInput.value;
    if (searchAddress.trim() !== '') {
        simulateSearch(searchAddress);
    }
});

chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  console.log("Content Script received message:", message);
  // Process the message as needed
  // Optionally, send a response back to the background script
  sendResponse({ success: true });
});

function simulateSearch(address) {
    let coordinates;
    let mapInfo; // Declare countyInfo variable outside the event handlers
    let clickedCounty;
    let clickedTwp;

    // Fetch geocoding data
    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${accessToken}`)
        .then(response => response.json())
        .then(data => {
            infoDiv.innerHTML = ''
            const features = data.features;
            if (features.length > 0) {
                coordinates = features[0].geometry.coordinates;
            }
        })
        .then(() => {
            // Fetch county data
            return fetch(`https://api.mapbox.com/v4/${countyTile}/tilequery/${coordinates[0]},${coordinates[1]}.json?access_token=${accessToken}`)
                .then(response => response.json());
        })
        .then(countyTileData => {
            // Process county data
            const countyFeatures = countyTileData.features;
            if (countyFeatures && countyFeatures.length > 0) {
                clickedCounty = countyFeatures[0].properties.NAME_2;
                console.log("County: ", clickedCounty);
                infoDiv.innerHTML += `<br><strong><span style="color: blue;">County:</span></strong> ${clickedCounty}<br>`;
            } else {
                console.log("Location is not within a county");
                infoDiv.innerHTML += "Location is not within a county<br>";
            }
        })
        .then(() => {
            // Fetch township data
            return fetch(`https://api.mapbox.com/v4/${twpTile}/tilequery/${coordinates[0]},${coordinates[1]}.json?access_token=${accessToken}`)
                .then(response => response.json());
        })
        .then(twpTileData => {
            // Process township data
            const townshipFeatures = twpTileData.features;
            if (townshipFeatures && townshipFeatures.length > 0) {
                clickedTwp = townshipFeatures[0].properties.LABEL;
                console.log("Township: ", clickedTwp);
                infoDiv.innerHTML += `<strong><span style="color: red;">Township/City:</span></strong> ${clickedTwp}<br>`;
            } else {
                console.log("Location is not within a township");
                infoDiv.innerHTML += "Location is not within a township<br>";
            }
        })
        .then(() => {
            // Fetch school data
            return fetch(`https://api.mapbox.com/v4/${schoolTile}/tilequery/${coordinates[0]},${coordinates[1]}.json?access_token=${accessToken}`)
                .then(response => response.json());
        })
        .then(schoolTileData => {
            const schoolFeatures = schoolTileData.features;
            if (schoolFeatures && schoolFeatures.length > 0) {
                const clickedSchoolName = schoolFeatures[0].properties.NAME;
                console.log("School: ", clickedSchoolName);
                infoDiv.innerHTML += `<strong><span style="color: purple;">School:</span></strong> ${clickedSchoolName}<br>`;
                
                fetch('michigan.json')
                    .then(response => response.json())
                    .then(data => {
                      const mapInfo = data;
                      let perc = "Percentage not calculated."
                      if (schoolFeatures && schoolFeatures.length > 0) {
                          let clickedSchoolName = schoolFeatures[0].properties.NAME.toLowerCase().split(' ');
                          let clickedSchool = schoolFeatures[0].properties.NAME;

                          // Words to be filtered out
                          const wordsToRemove = ['comm', 'community', 'school', 'schools', 'public', 'district'];

                          // Remove specific words from the clickedSchoolName array
                          clickedSchoolName = clickedSchoolName.filter(word => !wordsToRemove.includes(word));

                          // Split words on dash ("-") and flatten the array
                          clickedSchoolName = clickedSchoolName.flatMap(word => word.split('-'));

                          let rate = 'Rate not found'; // Default message if rate is not found
                          console.log(clickedSchoolName);
                          //console.log("^^ Real Clicked");
                          console.log(mapInfo)
                          const countyData = mapInfo[clickedCounty];
                          
                          if (countyData && countyData[clickedTwp]) {
                            const schoolsInTownship = countyData[clickedTwp][0];
                            console.log(schoolsInTownship);
                            
                            let foundRate = false; // Flag to check if a matching rate is found
                            
                            Object.keys(schoolsInTownship).forEach(school => {
                                const lowercaseSchool = school.toLowerCase();
                                const schoolWords = lowercaseSchool.split(/[\s-]+/);
                                console.log(schoolWords);
                                // Check if any word in the clicked school name matches a word in the school name
                                schoolWords.forEach(clickedWord => {
                                    if (clickedSchoolName.includes(clickedWord)) {
                                        const currentRate = schoolsInTownship[school].Rate;

                                        // Check if the rate is the same as another school's rate
                                        if (!foundRate || currentRate !== rate) {
                                            rate = currentRate;
                                            testSchool = schoolsInTownship[school];
                                            console.log(testSchool);

                                            infoDiv.innerHTML += `<strong><span style="color: green;">Rate:</span></strong> ${rate}<br>`;
                                            perc = rate * 0.05;
                                            finalPerc = perc.toFixed(2);
                                            infoDiv.innerHTML += `<strong><span style="color: black;">Percentage:</span></strong> ${finalPerc}%<br>`;
                                            foundRate = true;
                                        }
                                    }
                                });
                            });
                        }
                    }
                  })
                    .catch(error => {
                        console.error('Error fetching map data:', error);
                    });
            } else {
                console.log("Location is not within a school");
                infoDiv.innerHTML += "Location is not within a school<br>";
            }
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
}
</script>
</body>
</html>